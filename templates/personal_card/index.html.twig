{% extends 'base.html.twig' %}

{% block title %}Personal Cards{% endblock %}

{% block body %}
    <h1>Personal Cards</h1>

    <p>
        <a href="{{ path('personal_card_export_csv') }}" class="btn btn-primary">Export CSV</a>
        <a href="{{ path('personal_card_new') }}" class="btn btn-success">New Personal Card</a> <!-- New link added -->
    </p>

    <table>
        <thead>
        <tr>
            <th>Name</th>
            <th>Family</th>
            <th>Telephone</th>
            <th>Address</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% if personal_cards is not empty %}
            {% for personal_card in personal_cards %}
                <tr id="row-{{ personal_card.id }}">
                    <td>{{ personal_card.name }}</td>
                    <td>{{ personal_card.fam }}</td>
                    <td>{{ personal_card.tel }}</td>
                    <td>{{ personal_card.addr }}</td>
                    <td>
                        <a href="{{ path('personal_card_show', {'id': personal_card.id}) }}">show</a>
                        <a href="{{ path('personal_card_edit', {'id': personal_card.id}) }}">edit</a>
                        <button class="btn-delete" data-id="{{ personal_card.id }}"
                                data-csrf="{{ csrf_token('delete' ~ personal_card.id) }}">delete
                        </button>
                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="5">No records found</td>
            </tr>
        {% endif %}
        </tbody>
    </table>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $(document).ready(function () {
            $('.btn-delete').click(function (e) {
                e.preventDefault();

                var personalCardId = $(this).data('id');
                var csrfToken = $(this).data('csrf');

                var deleteUrl = '{{ path('personal_card_delete', {'id': 0}) }}';
                deleteUrl = deleteUrl.replace('0', personalCardId);

                if (confirm('Are you sure you want to delete this personal card?')) {
                    $.ajax({
                        url: deleteUrl,
                        method: 'POST',
                        data: {
                            '_method': 'DELETE',
                            '_token': csrfToken,
                        },
                        success: function (response) {
                            console.log('Success:', response);
                            if (response.success) {
                                $('#row-' + personalCardId).remove();
                            } else {
                                console.error('Failed to delete record');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error:', error);
                        }
                    });
                }
            });
        });
    </script>
{% endblock %}
